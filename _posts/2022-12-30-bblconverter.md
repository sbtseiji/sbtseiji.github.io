---
layout: post
title:  "bblconverter: Convert BibLaTeX bibliography files to LaTeX, markdown, and docx"
date:   2022-12-30 11:55:00 +0900
tags: 
- biblatex
- yaml
- python
---

After constructing the `.bbx` file for the purpose of managing a combination of Japanese and English citations using BibLaTeX, I gained an understanding of the way in which BibLaTeX generates bibliographies. As a result of this experience, I developed a tool called [`bblconverter`](https://github.com/sbtseiji/bblconverter), which allows for the conversion of bbl files generated by BibLaTeX to plain LaTeX, bibitem, markdown, and docx formats.

The `.bbl` file has a simple structure, merely arranging each item from the `.bib` file in a list format. Therefore, transforming it into a `.bib` or markdown file is not particularly difficult. Nevertheless, if the `.bbl` file is directly converted to LaTeX or markdown, the script will have to be rewritten if the paper is submitted to a journal with different reference list construction rules or if the reference list format is changed in the future, which is an undesired outcome. Hence, I opted to employ the YAML format for the bibliography in `bblconverter`.

The bblconverter enables the conversion of `.bbl` files into YAML lists to generate a reference list. As a result, both `.bbl` files and YAML formatted bibliography files can be used to create LaTeX, markdown, and docx bibliographies.

## YAML formatted bibliography file

The bibliography file in YAML format converted from the `.bbl` file has the following form.

```
- entry: Clement2002
  entrytype: book
  skip: false
  author:
  - family: Clement
    familyi: C.
    given: E.
    giveni: E.
  publisher:
  - Wiley
  sortinit: C
  sortinithash: 4d103a86280481745c9c897c925753c0
  extradatescope: labelyear
  labeldatesource:
  labelnamesource: author
  labeltitlesource: title
  subtitle: The Cornerstone of Learning
  title: Cognitive Flexibility
  year: 2002
  dateera: ce
```

Each entry is initiated with a pair of "`entry:`" keys and a citation key ("Clement2002" in the example), followed by the various elements of bibliographic information. The "`entrytype:`" denotes the type of bibliography, corresponding to "`@article`" or "`@book`" in the bib file. The subsequent "`skip:`" serves as a flag indicating whether or not to process this entry.

If an entry cites a related entry through the use of the "`related:`" field, such as a translated work or a book within a series, the cite key of the related entry will match the value of the "`related:`" field in the original entry. In these cases, the "`skip:`" field is designated as "`true`" and is not taken into account when generating the bibliography.

The fields associated with an author's or editor's name, such as "`author:`", provide information in a list format regarding each contributor. In these fields, "`family:`" represents the family name, "`familyi:`" stands for the initials of the family name, "`given:`" denotes the given name, and "`giveni:`" specifies the initials of the given name. 

The "`publisher`" is also treated as a list in BibLaTeX, however, it is unlikely to include more than one publisher, so I only consider the initial record in `bibconverter`. As such, it should function even if it states something like "`publisher: Wiley`". If you specify more than one, it could result in an error.

Since this YAML is a near exact replica of the contents of the `.bbl` file, it includes a lot of elements that are not mandatory for the creation of the bibliography. In this example, the "`sortinit:`", "`extradatescope:`", "`labelnamesource:`", "`labeltitlesource:`" and "`dateera:`" are not necessary. To observe what other components are present, attempt to convert an actual `.bbl` file to YAML. `bblconverter` gives you the capability to export a YAML-converted bib file.

## YAML for creating bibliography lists

The `bblconverter` makes use of a Domain Specific Language (DSL) written in YAML for constructing bibliographies. This allows a variety of publications to be supported through the creation of a formatter YAML that is compliant with the bibliography style of each journal. 

The `bblconverter` formatter YAML consists of three parts: `constants:` (constants), `names:` (names list), and `driver:` (formatter for each entry type). The initial section, `constants:`, states the constants required for the bibliographic format, for instance, the maximum number of authors to be mentioned in the bibliography. Here, one specifies the name and value of the constant in a dictionary format, as shown below. The constants listed here can be referred to in conditional clauses within the `driver:` portion. This section can be omitted if there is no necessity to use constants.

```
constants:
  maxnames: 20
```


The second part, `names:`, specifies fields which are regarded as namelists in BibLaTeX, such as the author's name and the editor's name. It is expressed as a list in the following manner:

```
names:
  - author
  - editor
  - editora
  - translator
  - translatora
  - origauthor
```

The third component of the YAML formatter, `driver:`, is the core component. It outlines the format of each entry type, such as `article:` and `book:`. The format of each entry type consists of "`field name: field format`," which is arranged in a list format in the order in which the elements appear in the bibliography list.

For example, if you want to format `article` entries as "author name, year, title, journal title, volume, and pages", you can write the YAML in the following structure. In this case, the name of each field must be the same as the field name utilized by BibLaTeX (the field name utilized in the bib file in YAML format).

```
article:
  - author: format of the author names
  - year: format of the published year
  - title: format of the article's title
  - journaltitle: format of the journal name
  - volume: format of the volume number
  - pages: format of the pages
```

The format of each field is described by assembling the relevant commands in a list form.

```
value::FIELDNAME　Retrieves and prints field value
text::"STRING"　prints specified text
delim::DELIMITER　prints a delimiter
italic::true　starts formatting text as italic
italic::false　ends formatting text as italic
bold::true　starts formatting text as bold
bold::false　ends formatting text as bold
punct::PUNCTUATION　prints punctuation mark
```

The initial command, `value::`, can be used to extract and display the value of a specific field. To illustrate, if you need to view the name of the journal in which the article was published, you can use the following statement:

```
- journaltitle: value::journaltitle
```

The second command, `text::`, prints out the specified string as-is. For instance, if you wish to display the year of publication in the format "(2001).", then you can use the following statement:

```
- year: 
  - text::"("
  - value::year
  - text::")."
```


The third command, `delim::`, is used to display delimiters, such as `delim::COLON`, in order to prevent the confusion that certain characters, like the colon (:), might create in YAML. The delimiters which can be used are `COLON`, `SPACE`, `COMMA`, `PERIOD`, `DOT` (equivalent to `PERIOD`), `DOTS` (...) `EMDASH`, `NDASH`, and `LINEBREAK`.

The commands `italic::true` and `italic::false`, as well as `bold::true` and `bold::false`, are used to define the type of text style. For instance, to display book titles in italics, the following statement should be used:

```
- booktitle: 
  - italic::true
  - value::booktitle
  - italic::false
```

The last command, `punct::`, is for correctly handling titles with and without punctuation, such as "This is my first paper" and "This is my second paper.". If the entries in your bib file have varying punctuation, the period at the end of the title "This is my second paper." will be duplicated as "This is my second paper.." when you specify your `title:` field in the following way:

```
- title: 
  - value::title
  - delim::DOT
```

In that case, you can use `punct::"."`, instead of `delim::DOT` or `text::"."`. 

```
- title: 
  - value::title
  - punct::"."
```

Then, the periods at the end of titles shall be addressed accurately, and both "This is my first paper" and "This is my second paper." shall be printed as "This is my first paper." and "This is my second paper."

### Conditional

The bblconverter permits the inclusion of conditionals in the `driver:` section. Conditionals are indicated by `cond::` and are specified in a list of three elements, with the false case being optional.

```
- - cond::CONDITIONAL
  - The value when the conditional is true
  - The value when the conditional is false
```

The following conditional are available:

* `cond::ifequal[value 1, value 2]`　Check if the values 1 and 2 are the same.
* `cond::ifgreater[value 1, value 2]`　Check if the value 1 is greater than the value 2.
* `cond::ifgreatereq[value 1, value 2]`　Check if the value 1 is greater than or equal to the value 2.
* `cond::ifless[value 1, value 2]`　Check if the value 1 is less than the value 2.
* `cond::iflesseq[value 1, value 2]`　Check if the value 1 is less than or equal to the value 2.
* `cond::ifdef[field::FIELDNAME, true]`　Check if the field `FIELDNAME` is defined.
* `cond::ifdef[field::FIELDNAME, false]`　Check if the field `FIELDNAME` is undefined.


Using the logical operators `&&`, `||`, and `^^`, you can also combine two conditionals. The second conditional does not have a `cond::`.

* `&&` logical conjunction　Ex) `cond::ifgreater[listcount,2]&&ifless[listcount,5]` (returns `true` when the value of the `listcount` variable is greater than two, and smaller than five)
*`||` logical disjunction　Ex) `cond::ifgreater[listcount,5]||ifless[listcount,2]` (returns `true` when the value of the `listcount` variable is greater than five, or smaller than two)
*`^^` exclusive disjunction　Ex)`cond::ifgreater[listtotal,2]^^ifdef[field::title,false]` (returns `true` when the value of the `listtotal` variable is greater than two, or the title field is undefined, but both are not true.）

### Variables

In addition to the constants defined by `constants:`, you can make use of the variables `listcount` and `listtotal` in conditional statements. The `listcount` is a value indicating the current author being processed, counting from the top, while the `listtotal` signifies the total number of authors included in the item. By utilizing these variables, you can omit the printing of author names if the number of authors exceeds 20, as demonstrated in the following example:

```
jname: &jname 
    - cond::ifequal[listcount,maxnames]&&ifless[listcount,listtotal]
    - delim::DOTS
    - - cond::ifgreater[listcount,maxnames]&&ifless[listcount,listtotal]
      - text::""
      - - cond::ifequal[listcount,1]
        - - value::family
          - text::", "
          - value::given
        - - cond::ifless[listcount,maxnames]
          - - text::", "
            - value::family
            - text::", "
            - value::given
          - - value::family
            - text::", "
            - value::given
```